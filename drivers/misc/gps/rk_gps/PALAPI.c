///////////////////////////////////////////////////////////////////////////////////
//
// Filename: PALAPI.c
// Author:	sjchen
// Copyright: 
// Date: 2010/12/01
// Description:
//			linux system interface
//
// Revision:
//		0.0.1
//
///////////////////////////////////////////////////////////////////////////////////
#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/string.h>
#include <linux/slab.h>
#include <linux/sched.h>
#include <linux/time.h>
#include <linux/fs.h>
#include <linux/delay.h>
#include <linux/spinlock.h>
#include <linux/mm.h>
#include <linux/miscdevice.h>
#include <asm/system.h>
#include <asm/page.h>
#include <asm/pgtable.h>
#include <asm/uaccess.h>

#include <linux/interrupt.h>
#include <asm/cacheflush.h>
#include <asm/cachetype.h>
#include <asm/io.h>
#include <linux/semaphore.h>

#include <mach/gpio.h>


///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_AllocMem
// Parameters:
// Description: allocate system memory
// Notes: sjchen 2010/12/01
//
///////////////////////////////////////////////////////////////////////////////////
void* PAL_AllocMem(int nBytes)
{
    return kmalloc ( nBytes, GFP_KERNEL);
}


///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_FreeMem
// Parameters:
// Description: free system memory
// Notes: sjchen 2010/12/01
//
///////////////////////////////////////////////////////////////////////////////////
void PAL_FreeMem(void* pMem)
{
   	if(pMem)
	{
        	kfree(pMem);
	}
}


///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_CreateMutex
// Parameters:
// Description: Create a semaphore
// Notes: sjchen 2010/12/01
//
///////////////////////////////////////////////////////////////////////////////////
int	PAL_CreateMutex		( void)
{
	struct semaphore  *psem;

	psem = (struct semaphore *)PAL_AllocMem(sizeof(struct semaphore));
	//init_MUTEX_LOCKED(psem);
	sema_init(psem, 0);
	return  (int)psem;

}

///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_ReleaseMutex
// Parameters:
// Description: Release a semaphore
// Notes: sjchen 2010/12/01
//
///////////////////////////////////////////////////////////////////////////////////
void	PAL_ReleaseMutex	( int hMutex )
{
	if(hMutex)
	{
	    up((struct semaphore *)hMutex);
	}

	return ;
}

///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_WaitMutex
// Parameters:
// Description: Wait semaphore to signal
// Notes: sjchen 2010/12/01
//
///////////////////////////////////////////////////////////////////////////////////
void   PAL_WaitMutex(int hMutex)
{
	if(hMutex)
	{
	    down((struct semaphore *)hMutex);
	}
}

///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_CloseMutes
// Parameters:
// Description: Close a semaphore
// Notes: sjchen 2010/12/01
//
///////////////////////////////////////////////////////////////////////////////////
void  PAL_CloseMutes(int hMutex)
{
	if(hMutex)
	{
		PAL_FreeMem((void *)hMutex);
	}
}


///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_memset
// Parameters:
// Description:
// Notes: sjchen 2010/12/01
//
///////////////////////////////////////////////////////////////////////////////////
void PAL_memset (
	void*	        pbuf,
	unsigned char	nval,
	int 	nsize
	)
{
	memset ( pbuf, nval, nsize );
}

///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_memcpy
// Parameters:
// Description:
// Notes: sjchen 2010/12/01
//
///////////////////////////////////////////////////////////////////////////////////
void PAL_memcpy (
	void*	pDst,
	void*	pSrc,
	int	nSize
	)
{
	memcpy ( pDst, pSrc, nSize );
}


///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_GetCurTimer_US
// Parameters:
// Description: Get system time 
// Notes: sjchen 2010/11/30
//
///////////////////////////////////////////////////////////////////////////////////
void PAL_GetCurTimer_US(
					  int *n32Second,
					  int *n32us
	)
{
	struct timeval  tv;

	do_gettimeofday(&tv);

	*n32Second = tv.tv_sec;
	*n32us     = tv.tv_usec;
	//printk("n32Second=%d\n",*n32Second);
}


///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_GetCurTimer_US
// Parameters:
// Description: Get system time 
// Notes: sjchen 2010/11/30
//
///////////////////////////////////////////////////////////////////////////////////
void PAL_GetSysTimer_US(
						int *n32Second,
						int *n32us
						)
{
	PAL_GetCurTimer_US(n32Second, n32us);
}

///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_GetKernelFreePage
// Parameters:
// Description: Allocate kernel free page
// Notes: sjchen 2010/11/30
//
///////////////////////////////////////////////////////////////////////////////////
int PAL_GetKernelFreePage(int nPageSize)
{
	return __get_free_pages(GFP_KERNEL,get_order(nPageSize));
}


///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_FreeKernelPage
// Parameters:
// Description: Free kernel page
// Notes: sjchen 2010/11/30
//
///////////////////////////////////////////////////////////////////////////////////
void PAL_FreeKernelPage(int nAddr,int nPageSize)
{
	if(nAddr != 0 && nPageSize != 0)
	{
		free_pages(nAddr,get_order(nPageSize)); 
	
	}
}

///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_GetUser
// Parameters:
// Description: 
// Notes: sjchen 2010/11/30
//
///////////////////////////////////////////////////////////////////////////////////
int  PAL_GetUser(int *p)
{
	int nData = 0;
	
	__get_user(nData,(int __user *)p);

	return nData;
}

///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_CopyFromUser
// Parameters:
// Description: Copy datas from user space to kernel space
// Notes: sjchen 2010/11/30
//
///////////////////////////////////////////////////////////////////////////////////
void PAL_CopyFromUser(void *pDest,void *pSrc,int nSize)
{
	__copy_from_user(pDest,(void __user *)pSrc,nSize);
}


///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_CopyToUser
// Parameters:
// Description: Copy datas from kernel space to user space
// Notes: sjchen 2010/11/30
//
///////////////////////////////////////////////////////////////////////////////////
int PAL_CopyToUser(void *pDest,void *pSrc,int nSize)
{
	return copy_to_user((void __user *)pDest, pSrc, nSize);
}

///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_Sprintf
// Parameters:
// Description:
// Notes: sjchen 2010/11/04
//
///////////////////////////////////////////////////////////////////////////////////
int PAL_Sprintf (
	char * pDst,
	const char * pFormat,
	...
	)
{
	int nNum = 0;

	va_list ptr;

	va_start ( ptr, pFormat );

	nNum = vsprintf ( pDst, pFormat, ptr );

	va_end ( ptr );

	return nNum;
}
///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_Sprintf
// Parameters:
// Description:
// Notes: sjchen 2010/11/04
//
///////////////////////////////////////////////////////////////////////////////////
void PAL_KDEBUG (
	const char * pFormat,
	...
	)
{
#if 1
	va_list ptr;
	
	va_start ( ptr, pFormat );

	vprintk ( pFormat, ptr );

	va_end ( ptr );
#endif
	return ;
}

///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_mdelay
// Parameters:
// Description:
// Notes: sjchen 2010/11/04
//
///////////////////////////////////////////////////////////////////////////////////
void PAL_mdelay(int ms)
{
	mdelay(ms);
}

///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_dma_cache_wback_inv
// Parameters:
// Description:
// Notes: sjchen 2010/11/04
//
///////////////////////////////////////////////////////////////////////////////////
void PAL_dma_cache_wback_inv(void * pMem, int size )
{
	//TODO:
	//fluch cache
	
//	__cpuc_flush_dcache_area(pMem, size );
}


///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_dma_cache_wback_inv
// Parameters:
// Description:
// Notes: sjchen 2010/11/04
//
///////////////////////////////////////////////////////////////////////////////////
void PAL_dma_cache_inv(void * pMem, int size )
{
	//TODO:
	//fluch cache
	
//	__cpuc_flush_dcache_area(pMem, size );
}



///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_Set_GPIO_Pin
// Parameters:
// Description:
// Notes: sjchen 2010/11/04
//
///////////////////////////////////////////////////////////////////////////////////
void PAL_Set_GPIO_Pin(int gpio)
{
	//TODO:
	//Set gpio to high level	
	gpio_set_value(gpio, GPIO_HIGH);
}

///////////////////////////////////////////////////////////////////////////////////
// 
// Function Name:PAL_Clr_GPIO_Pin
// Parameters:
// Description:
// Notes: sjchen 2010/11/04
//
///////////////////////////////////////////////////////////////////////////////////
void PAL_Clr_GPIO_Pin(int gpio)
{
	//TODO:
	//Set gpio to low level
	gpio_set_value(gpio, GPIO_LOW);
}


